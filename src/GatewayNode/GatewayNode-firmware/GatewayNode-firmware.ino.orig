
/***************************************************************
* Gateway Node firmware
*
* @author Robbie Sharma robbie -at- rsconsulting.ca
* @date August 21, 2017
* @desc Before upload, flip switch to "USB" on the arduino Shield
* 
*  TODO:  Develop a simple protocol framework with handshaking
*  for transmitting data between xBee modules and Server. 
***************************************************************/

#include <SoftwareSerial.h>

// Incresae software serial maximum buffer size 
#define _SS_MAX_RX_BUFF 256
#define MAX_BUF_SIZE 64

// RX,  TX
SoftwareSerial xBeeSerial(A0,A1); //RX,TX



void outputStream(Stream &s_in, Stream &s_out, bool printRX = false){

  uint8_t bytesToRead;
  bytesToRead = s_in.available();

  
  
  if(bytesToRead > 0){
    uint8_t *dataBuf;
    dataBuf = new uint8_t[min(bytesToRead,MAX_BUF_SIZE)];
    s_in.readBytes(dataBuf, bytesToRead);
    
    for(int i=0; i<bytesToRead; i++){
      s_out.write(dataBuf[i]);
    }
    delete [] dataBuf;  
  }
  
}

void setup() {
  Serial.begin(115200);

  while(!Serial){
    ;
  }

  Serial.println("USB Serial open...");
  
  xBeeSerial.begin(57600);

}

void loop() {

<<<<<<< HEAD
  if(Serial.available()>0)
    xBeeSerial.write(Serial.read());
  
  if(xBeeSerial.available()>0)
    Serial.write(xBeeSerial.read());
  
  /*
  outputStream(xBeeSerial, Serial);
=======
  outputStream(xBeeSerial, Serial, true);
>>>>>>> feature/crc-experiment
  delay(10);
  outputStream(Serial,xBeeSerial);
  delay(10);
  */
}

